version: v1.0
name: Go project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build project
    task:
      jobs:
      - name: Get Go packages
        commands:
          - checkout
          - go get github.com/lib/pq
          - sem-service start postgres
          - echo "Build Go binary"

  - name: Unit Tests
    task:
      jobs:
      - name: Test Web Server
        commands:
          - checkout
          - echo "Restore from cache"
          - echo "Testing Go Packages"

      - name: Test Postgres
        commands:
          - sem-service start postgres
          - sleep 5
          - psql -p 5432 -h localhost -U postgres -c "Select NOW()"


  - name: Integration Tests
    task:
      jobs:
      - name: Web Server + DBMS
        commands:
          - checkout
          - sem-service start postgres
          - echo "Restore binary from cache"
          - echo "Testing Integration"

  - name: Test application
    task:
      jobs:
      - name: Interact with application
        commands:
          - checkout
          - sem-service start postgres
          - echo "Populate PostgreSQL"
          - echo "Restore from cache"

